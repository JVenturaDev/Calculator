<div class="workspace-area">

  <!-- Crear nuevo item -->
  <div *ngIf="creatingItem" class="new-item" (click)="$event.stopPropagation()">
    <input type="text" placeholder="Título del cálculo" [(ngModel)]="newItemTitle" (click)="$event.stopPropagation()" />

    <app-workspace-tags [tags]="newItemTags"></app-workspace-tags>

    <button (click)="$event.stopPropagation()" (click)="saveNewItem()">Guardar</button>
    <button (click)="$event.stopPropagation()" (click)="creatingItem = false">Cancelar</button>
  </div>

  <!-- Items del workspace -->
  <div *ngFor="let item of workspaceItems; trackBy: trackById" class="workspace-item" (click)="activateItem(item.id)">
    <h3>{{ item.title }}</h3>

    <!-- Input del item activo -->
    <div *ngIf="activeItemId === item.id" class="item-input" (click)="$event.stopPropagation()">
      <input #workspaceInput type="text" placeholder="" [ngModel]="item.currentExpression"
        (ngModelChange)="wsService.updateCurrentExpression(item.id, $event)"
        (focus)="inputService.setWorkspaceItemTarget(item.id)" />
      <button (click)="$event.stopPropagation(); evaluateWorkspaceItem()">=</button>
    </div>

    <!-- Historial del item -->
    <div *ngFor="let calc of item.calculations" class="calc-row">
      <b>{{ calc.expression }}</b> → {{ calc.result }}

      <!-- Pasos -->
      <div *ngIf="calc.steps.length">
        <div *ngFor="let step of calc.steps">
          {{ step.type }}: {{ step.name }}
          ({{ step.operands.join(', ') }}) = {{ step.result }}
        </div>
      </div>
    </div>

    <!-- Tags -->
    <app-workspace-tags [tags]="item.tags" (tagsChange)="wsService.updateTags(item.id, $event)">
    </app-workspace-tags>
  </div>

  <button *ngIf="!creatingItem" (click)="creatingItem = true">
    Nuevo Item
  </button>
</div>